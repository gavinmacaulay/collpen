setwd('/repositories/CollPen_mercurial/vesselavoidancepaper')
library(R.matlab)

#####################################
#                                   #
# Figure 3 Observed stimuli figure  #
#                                   #
#####################################

fw1 <- 0.0393701*122
fh1 <- 0.0393701*130

dat <- readMat("Figure1.mat")

#pdf("Figure1.pdf",width = fw1, height = fh1)
png(filename="Figure3.png",width = fw1, height = fh1, units="in",res=700)

par(mfrow=c(3,3),omi=c(0.1,0.1,0.1,0.1),mar=c(4, 4.5, .8, .4), bty ="l")

plot(dat$fig11.1[1,],dat$fig11.1[2,],'col'=gray(.8),xlim=c(-10,40),ylim=c(100,150),type="l",xlab="time (s)",ylab=expression(paste("SPL (dB re 1",mu,"Pa)")))
lines(dat$fig11.2[1,],dat$fig11.2[2,])
mtext("(a)",side=3,line=0,adj=0)

plot(dat$fig12.1[1,],dat$fig12.1[2,],'col'=gray(.8),xlim=c(-10,40),ylim=c(100,150),type="l",xlab="time (s)",ylab="")
lines(dat$fig12.2[1,],dat$fig12.2[2,])
mtext("(b)",side=3,line=0,adj=0)
plot(dat$fig13.1[1,],dat$fig13.1[2,],'col'=gray(.8),xlim=c(-10,40),ylim=c(100,150),type="l",xlab="time (s)",ylab="")
mtext("(c)",side=3,line=0,adj=0)
lines(dat$fig13.2[1,],dat$fig13.2[2,])

plot(dat$fig21.1[1,]/1000,dat$fig21.1[2,],xlim=c(-10,40),ylim=c(-5,5),type="l",xlab="time (ms)",ylab="Pressure (Pa)")
lines(dat$fig21.2[1,]/1000,dat$fig21.2[2,],'col'=gray(.8))
mtext("(d)",side=3,line=0,adj=0)
plot(dat$fig22.2[1,]/1000,dat$fig22.2[2,],xlim=c(-10,40),ylim=c(-50,50),type="l",xlab="time (ms)",ylab="")
lines(dat$fig22.1[1,]/1000,dat$fig22.1[2,],'col'=gray(.8))
mtext("(e)",side=3,line=0,adj=0)
plot(dat$fig23.2[1,]/1000,dat$fig23.2[2,],xlim=c(-10,40),ylim=c(-50,50),type="l",xlab="time (ms)",ylab="")
lines(dat$fig23.1[1,]/1000,dat$fig23.1[2,],'col'=gray(.8))
mtext("(f)",side=3,line=0,adj=0)

plot(dat$fig31.1[1,],dat$fig31.1[2,],'col'=gray(.8),ylim=c(40,140),type="l",xlab="frequency (Hz)",ylab=expression(paste("PSD (dB re 1",mu,"P",a^2," H",z^-1,")")))
lines(dat$fig31.2[1,],dat$fig31.2[2,])
mtext("(g)",side=3,line=0,adj=0)
plot(dat$fig32.1[1,],dat$fig32.1[2,],'col'=gray(.8),ylim=c(40,140),type="l",xlab="frequency (Hz)",ylab="")
lines(dat$fig32.2[1,],dat$fig32.2[2,])
mtext("(h)",side=3,line=0,adj=0)
plot(dat$fig33.1[1,],dat$fig33.1[2,],'col'=gray(.8),ylim=c(40,140),type="l",xlab="frequency (Hz)",ylab="")
lines(dat$fig33.2[1,],dat$fig33.2[2,])
mtext("(i)",side=3,line=0,adj=0)

dev.off()

#####################################
#                                   #
#        Figure 4: The responses    #
#                                   #
#####################################

#
# Manual scoring data set
#

file <- 'C:/repositories/CollPen_mercurial/score_anova_simple.csv'
dat<-read.table(file,sep = ";",header = TRUE)
library(nlme)
# Vessel noise data only
T2<-dat[(dat$s_treatmenttype=='vessel'),]
# Only block>20
T2<-T2[(T2$b_block>20),]

# Day number
T2$day<-floor(T2$t_start_time_mt) - min(floor(T2$t_start_time_mt))+1


T3 <- data.frame(block=T2$b_block, subblock=T2$s_subblock,treatment=T2$t_treatment, type=factor(T2$t_treatmenttype, label=c("GOS","GOSup","JH")), 
                 groupsize=factor(T2$b_groupsize, label=c("L","S")),day=T2$day,score=T2$v_score)


T2_aov <- aov(T2$v_score ~ factor(T2$t_treatmenttype) + factor(T2$b_groupsize) + factor(T2$t_treatmenttype)*factor(T2$b_groupsize))
summary(T2_aov)

#
# Echo sounder data VA/DP analysis
#

library(XLConnect)
# This file is generated by cpscr_vapaper_figures.m
va <- loadWorkbook("VAvessel_ch2.xls", create = F)
dat<-readWorksheet(va,sheet="Sheet1", startRow = 0, endRow = 0, startCol = 0, endCol = 0)

# VA ratios (vertical echo sounder)
VAv <- log(dat$sv/dat$sv_0)
VAvl <- (dat$sv/dat$sv_0)

VA_aov <- aov(VAv ~ factor(dat$type) + factor(dat$groupsize) + factor(dat$type)*factor(dat$groupsize)+factor(dat$block))
summary(VA_aov)
bartlett.test(VAv ~ factor(dat$type) + factor(dat$groupsize)+ factor(dat$type)*factor(dat$groupsize)+factor(dat$block))
TukeyHSD(VA_aov,ordered=T)

VA_bx <- boxplot(VAv ~ factor(dat$type) + factor(dat$groupsize))
VA_bx$stats <- exp(VA_bx$stats)
VA_bx$out <- exp(VA_bx$out)
VA_bx$conf <- exp(VA_bx$conf)

mean(VAvl[!is.na(VAvl)])
# t-test in log domain
t.test(VAv)

# Depth difference
DPv <- (dat$m_0 - dat$m)
DP_aov <- aov(DPv ~ factor(dat$type) + factor(dat$groupsize) + factor(dat$type)*factor(dat$groupsize)+factor(dat$block))
summary(DP_aov)
bartlett.test(DPv ~ factor(dat$type) + factor(dat$groupsize) + factor(dat$type)*factor(dat$groupsize)+factor(dat$block))
TukeyHSD(DP_aov,ordered=T)

DP_bx <- boxplot(DPv ~ factor(dat$type) + factor(dat$groupsize))
mean(DPv[!is.na(DPv)])
t.test(DPv)

#
# Didson information (large group only)
#

didf <- loadWorkbook("Dvessel.xls", create = F)
did<-readWorksheet(didf,sheet="Sheet1", startRow = 0, endRow = 0, startCol = 0, endCol = 0)

# Pick only large school size
did<-did[(did$groupsize=='L'),]

dspeed <- (did$speed-did$speed_0)
DS_aov <- aov(dspeed ~  factor(did$type) + factor(did$block))
summary(DS_aov)
boxplot(dspeed ~ factor(did$type))

# CAV difference
dcav <- (did$cav - did$cav_0)
cav_aov <- aov(dcav ~ factor(did$type) + factor(did$block))
summary(cav_aov)
boxplot(dcav ~ factor(did$type))

#
# Figure 3: Plotting
#

library(ggplot2)
require(gridExtra)

fw2 <- 0.0393701*90*1.2
fh2 <- 0.0393701*80*2
pdf("figure4.pdf",width = fw2, height = fh2)
#par(mfrow=c(3,1),omi=c(0.1,0.1,0.1,0.1),mar=c(4, 4.5, .8, .4), bty ="l")
#boxplot(T2$v_score ~ as.integer(T2$t_treatmenttype) + T2$b_groupsize,ylab="Score",names=F)

Score <- data.frame(vessel=factor(as.integer(T2$t_treatmenttype), label=c("GOS","GOSup","JH")), 
                 groupsize=factor(T2$b_groupsize, label=c("Large","Small")),
                 Score=T2$v_score)

p1<-ggplot(aes(y=Score, x = vessel, fill = groupsize),data=Score) +
     geom_boxplot(aes(colour = factor(groupsize),ylab="Score"),colour='black') + 
     xlab("") +
     ylab("Score") +
     scale_fill_manual('groupsize', values = c('Large' = 'grey90', 'Small' = 'grey50'))  +
     theme_bw() +
     opts(axis.line = theme_segment(colour = "black"),
        panel.grid.major = theme_blank(),
        panel.grid.minor = theme_blank(),
        panel.border = theme_blank())+
        geom_vline(xintercept = 0)
        
VA <- data.frame(vessel=factor(dat$type, label=c("GOS","GOSup","JH")), 
                 groupsize=factor(dat$groupsize, label=c("Large","Small")),
                 VAvl=VAvl)

p2<- ggplot(aes(y=VAvl, x = vessel, fill = groupsize),data=VA) +
     geom_boxplot(aes(colour = factor(groupsize)),colour='black') + 
     xlab(" ") +
     ylab("VA") +
     scale_fill_manual('groupsize', values = c('Large' = 'grey90', 'Small' = 'grey50'))  +
     theme_bw() +
     opts(axis.line = theme_segment(colour = "black"),
        panel.grid.major = theme_blank(),
        panel.grid.minor = theme_blank(),
        panel.border = theme_blank())+
        geom_vline(xintercept = 0)

VertChange <- data.frame(vessel=factor(dat$type, label=c("GOS","GOSup","JH")), 
                 groupsize=factor(dat$groupsize, label=c("Large","Small")),
                 DPv=DPv)

p3<-ggplot(aes(y=DPv, x = vessel, fill = groupsize),data=VertChange) +
     geom_boxplot(aes(colour = factor(groupsize)),colour='black') + 
     ylab("Vertical change (m)") +
     scale_fill_manual('groupsize', values = c('Large' = 'grey90', 'Small' = 'grey50'))  +
     theme_bw() +
     opts(axis.line = theme_segment(colour = "black"),
        panel.grid.major = theme_blank(),
        panel.grid.minor = theme_blank(),
        panel.border = theme_blank())+
        geom_vline(xintercept = 0)

grid.arrange(p1, p2, p3)

dev.off()


# Create merged data set

!(names(dat) %in% "score")

# merge two data frames by ID and Country
total <- merge(dat[!(names(dat) %in% "score")],did,by=c("block","subblock","treatment","groupsize","type"),all.x=T,all.y=T)
total2 <- merge(total,T3,by=c("block","subblock","treatment","groupsize","type"),all.x=F,all.y=T)

total2["block"] <- total2["block"]-20

# Add day to the data.

# Load workbook (create if not existing)
wb <- loadWorkbook("SuppData.xlsx", create = TRUE)

# Create a worksheet called 'CO2'
createSheet(wb, name = "SuppData")

# Write built-in data set 'CO2' to the worksheet created above;
# offset from the top left corner and with default header = TRUE
writeWorksheet(wb, total2, sheet = "SuppData")

# Save workbook (this actually writes the file to disk)
saveWorkbook(wb)


